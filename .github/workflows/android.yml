name: Android CI

on:
  push:
    branches: [ "main" ]
  pull_request:
  schedule:
    - cron: "0 3 * * *"

permissions:
  contents: read
  pull-requests: write
  security-events: write

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build:
    name: Build & Validate
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Enable Gradle Build Cache
        uses: gradle/gradle-build-action@v2

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"
          cache: gradle

      - name: Make gradlew executable
        run: chmod +x gradlew

      - name: Run Android Lint (Strict Mode)
        run: ./gradlew lint

      - name: Run Detekt
        run: ./gradlew detekt
        continue-on-error: true

      - name: Detekt Reviewdog (PR Comments)
        uses: alaegin/Detekt-Action@v1.23.5
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          detekt_config: detekt.yml
          reviewdog_reporter: github-pr-review
          fail_on_error: false
          reviewdog_filter: diff_context

      - name: Upload Detekt SARIF
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: "**/build/reports/detekt/*.sarif"

      - name: Run Unit Tests
        run: |
          echo "::group::Unit Tests"
          ./gradlew test
          echo "::endgroup::"

      - name: Generate Kover Coverage XML
        run: ./gradlew koverXmlReport

      - name: Upload Coverage Report
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: build/reports/kover/report.xml

      - name: Comment Kover Coverage on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const xmlPath = 'build/reports/kover/report.xml';

            if (!fs.existsSync(xmlPath)) {
              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: "‚ö†Ô∏è Kover coverage report was not found."
              });
              return;
            }

            const xml = fs.readFileSync(xmlPath, 'utf8');
            const match = xml.match(/<counter type="INSTRUCTION" missed="(\d+)" covered="(\d+)"/);

            if (!match) {
              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: "‚ö†Ô∏è Could not parse Kover coverage report."
              });
              return;
            }

            const missed = parseInt(match[1]);
            const covered = parseInt(match[2]);
            const total = missed + covered;
            const pct = ((covered / total) * 100).toFixed(2);

            const summary =
              "### üß™ Test Coverage Report (Kover)\n" +
              "**Coverage:** " + pct + "%\n\n" +
              "- **Covered:** " + covered + "\n" +
              "- **Missed:** " + missed + "\n" +
              "- **Total:** " + total + "\n\n" +
              "‚¨Ü Add more tests to improve coverage!\n";

            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: summary,
            });

      - name: Job Summary
        uses: actions/github-script@v7
        with:
          script: |
            await core.summary
              .addHeading("Android CI Summary")
              .addRaw("‚úî Lint, Detekt, Tests, and Coverage completed")
              .write();

      - name: Build Debug APK
        run: ./gradlew assembleDebug
