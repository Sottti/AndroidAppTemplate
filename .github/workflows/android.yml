# Android CI workflow: runs lint, detekt, tests, coverage, nightly scans, and APK build
name: Android CI

# Triggers for CI: on pushes to main, PRs, and nightly scheduled build
on:
  push:
    branches: [ "main" ]
  pull_request:
  schedule:
    - cron: "0 3 * * *"

# Minimal permissions required for commenting on PRs and uploading SARIF
permissions:
  contents: read
  pull-requests: write
  security-events: write

# Cancel previous runs on the same branch to speed up CI
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

# Main CI job: Build & Validate pipeline
jobs:
  build:
    name: Build & Validate
    runs-on: ubuntu-latest
    # Kotlin incremental compilation for faster builds
    env:
      GRADLE_OPTS: -Dkotlin.incremental=true

    steps:
      # Checkout repository with shallow clone for speed
      # -----------------------------
      # CHECKOUT
      # -----------------------------
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      # Enable Gradle build caching across CI runs
      # -----------------------------
      # GRADLE BUILD CACHE
      # -----------------------------
      - name: Gradle Build Cache
        uses: gradle/gradle-build-action@v2

      # Install JDK 17 required by AGP 8+
      # -----------------------------
      # SETUP JAVA
      # -----------------------------
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: "temurin"
          java-version: "17"
          cache: "gradle"

      # Make gradlew executable for Linux runners
      # -----------------------------
      # PERMISSIONS FOR GRADLE
      # -----------------------------
      - name: Make gradlew executable
        run: chmod +x gradlew

      # Run Android Lint in strict mode (treat warnings as errors)
      # -----------------------------
      # STRICT LINT (warnings = errors)
      # -----------------------------
      - name: Run Android Lint (strict mode)
        run: ./gradlew lint --warning-mode all

      # Comment Android Lint issues directly on the PR using Reviewdog
      # -----------------------------
      # ANDROID LINT REVIEWDOG (PR COMMENTS)
      # -----------------------------
      - name: Android Lint Reviewdog (PR Comments)
        uses: reviewdog/action-android-lint@v1
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          reporter: github-pr-review
          fail_on_error: true
          android_lint_path: "**/build/reports/lint-results.xml"

      # Run Detekt static analysis (local and PR)
      # -----------------------------
      # RUN DETEKT
      # -----------------------------
      - name: Run Detekt
        run: ./gradlew detekt

      # Reviewdog comments Detekt issues on the PR
      # -----------------------------
      # RUN DETEKT WITH REVIEWDOG (PR COMMENTS)
      # -----------------------------
      - name: Detekt Reviewdog (PR Comments)
        uses: reviewdog/action-detekt@v1
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          detekt_config: detekt.yml
          reporter: github-pr-review
          fail_on_error: true
          filter_mode: diff_context

      # Upload Detekt SARIF for GitHub code scanning UI
      # -----------------------------
      # UPLOAD DETEKT SARIF TO PRs
      # -----------------------------
      - name: Upload Detekt SARIF
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: "**/build/reports/detekt/*.sarif"

      # Execute unit tests with grouped logs for readability
      # -----------------------------
      # RUN UNIT TESTS
      # -----------------------------
      - name: Run Unit Tests
        run: |
          echo "::group::Unit Tests"
          ./gradlew test
          echo "::endgroup::"

      # Generate Kover XML coverage report and upload as artifact
      # -----------------------------
      # KOVER COVERAGE REPORT
      # -----------------------------
      - name: Generate Kover Coverage XML
        run: ./gradlew koverXmlReport

      - name: Upload Coverage Report
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: build/reports/kover/report.xml

      # Parse Kover XML and comment summarized coverage on PR
      # -----------------------------
      # POST KOVER COVERAGE SUMMARY AS PR COMMENT
      # -----------------------------
      - name: Comment Kover Coverage on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const xmlPath = 'build/reports/kover/report.xml';

            if (!fs.existsSync(xmlPath)) {
              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: "‚ö†Ô∏è Kover coverage report was not found."
              });
              return;
            }

            const xml = fs.readFileSync(xmlPath, 'utf8');
            const match = xml.match(/<counter type="INSTRUCTION" missed="(\d+)" covered="(\d+)"/);

            if (!match) {
              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: "‚ö†Ô∏è Could not parse Kover coverage report."
              });
              return;
            }

            const missed = parseInt(match[1]);
            const covered = parseInt(match[2]);
            const total = missed + covered;
            const pct = ((covered / total) * 100).toFixed(2);

            const summary =
              "### üß™ Test Coverage Report (Kover)\n" +
              "**Coverage:** " + pct + "%\n\n" +
              "- **Covered:** " + covered + "\n" +
              "- **Missed:** " + missed + "\n" +
              "- **Total:** " + total + "\n\n" +
              "‚¨Ü Add more tests to improve coverage!\n";
            
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: summary,
            });

      # Add a summary to the GitHub job for quick status info
      # -----------------------------
      # JOB SUMMARY
      # -----------------------------
      - name: Job Summary
        uses: actions/github-script@v7
        with:
          script: |
            await core.summary
              .addHeading("Android CI Summary")
              .addRaw("‚úî Lint, Detekt, Tests, and Coverage completed")
              .write();

      # Build debug APK to ensure project compiles successfully
      # -----------------------------
      # BUILD DEBUG APK
      # -----------------------------
      - name: Build Debug APK
        run: ./gradlew assembleDebug
